<template>
  <section>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="32"
      height="32"
      viewBox="0 0 48 48"
      style="width: 200px; height: 200px; margin: 0 auto; display: block"
    >
      <path
        fill="#45413c"
        d="M10 45.5a14 1.5 0 1 0 28 0a14 1.5 0 1 0-28 0Z"
        opacity=".15"
      />
      <path
        fill="#bf8df2"
        d="M8.71 23.29a15.29 15.29 0 1 0 30.58 0a15.29 15.29 0 1 0-30.58 0Z"
      />
      <path
        fill="#9f5ae5"
        d="M24 8a15.29 15.29 0 1 0 15.29 15.29A15.3 15.3 0 0 0 24 8Zm0 25a12.31 12.31 0 1 1 12.31-12.32A12.31 12.31 0 0 1 24 33Z"
      />
      <path
        fill="none"
        stroke="#45413c"
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M8.71 23.29a15.29 15.29 0 1 0 30.58 0a15.29 15.29 0 1 0-30.58 0Z"
      />
      <path
        fill="#dabff5"
        d="M26.24 18.07a3.73 3.73 0 1 0 7.46 0a3.73 3.73 0 1 0-7.46 0Zm-4.48 1.86a1.12 1.12 0 1 0 2.24 0a1.12 1.12 0 1 0-2.24 0Zm.01-5.96a1.86 1.86 0 1 0 3.72 0a1.86 1.86 0 1 0-3.72 0Z"
      />
      <path
        fill="#bf8256"
        d="M36.48 39.68a1.49 1.49 0 0 1-.55 1.94c-1.77 1.1-5.66 2.93-11.93 2.93s-10.16-1.83-11.93-2.93a1.49 1.49 0 0 1-.55-1.94l2.41-4.83A24.94 24.94 0 0 0 24 37.09a24.94 24.94 0 0 0 10.07-2.24Z"
      />
      <path
        fill="#915e3a"
        d="M24 39.81a34.84 34.84 0 0 0 11.5-2.09l-1.43-2.87A24.94 24.94 0 0 1 24 37.09a24.94 24.94 0 0 1-10.07-2.24l-1.43 2.87A34.84 34.84 0 0 0 24 39.81Z"
      />
      <path
        fill="none"
        stroke="#45413c"
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M36.48 39.68a1.49 1.49 0 0 1-.55 1.94c-1.77 1.1-5.66 2.93-11.93 2.93s-10.16-1.83-11.93-2.93a1.49 1.49 0 0 1-.55-1.94l2.41-4.83A24.94 24.94 0 0 0 24 37.09a24.94 24.94 0 0 0 10.07-2.24Z"
      />
      <path
        fill="#fff"
        stroke="#45413c"
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M11.92 15.56a1.82 1.82 0 0 1 1.35-1.34L16 13.6a.22.22 0 0 0 .17-.22a.21.21 0 0 0-.17-.21l-2.69-.63a1.79 1.79 0 0 1-1.35-1.34l-.66-2.69a.22.22 0 0 0-.22-.17a.21.21 0 0 0-.21.17l-.62 2.69a1.79 1.79 0 0 1-1.35 1.34l-2.69.63a.21.21 0 0 0-.17.21a.22.22 0 0 0 .17.22l2.69.62a1.82 1.82 0 0 1 1.35 1.34l.62 2.7a.21.21 0 0 0 .21.17a.22.22 0 0 0 .22-.17Zm23.6-6.83L37.63 8a.21.21 0 0 0 .13-.19a.2.2 0 0 0-.13-.19l-1.74-.58a.78.78 0 0 1-.5-.5l-.57-1.73a.21.21 0 0 0-.19-.13a.2.2 0 0 0-.19.13l-.58 1.73a.76.76 0 0 1-.5.5l-1.73.58a.2.2 0 0 0-.13.19a.21.21 0 0 0 .13.19l1.73.57a.8.8 0 0 1 .5.5l.58 1.74a.2.2 0 0 0 .19.13a.21.21 0 0 0 .19-.13Zm9.69 21.63l2.11-.7a.21.21 0 0 0 .14-.19a.2.2 0 0 0-.14-.19l-1.73-.58a.78.78 0 0 1-.5-.5l-.58-1.73a.2.2 0 0 0-.19-.13a.18.18 0 0 0-.18.13l-.58 1.73a.78.78 0 0 1-.5.5l-1.73.58a.2.2 0 0 0-.14.19a.21.21 0 0 0 .14.19l1.73.57a.8.8 0 0 1 .5.5l.58 1.74a.18.18 0 0 0 .18.13a.2.2 0 0 0 .19-.13ZM4.57 34.83l2.1-.7a.2.2 0 0 0 .14-.19a.19.19 0 0 0-.14-.18l-1.73-.58a.83.83 0 0 1-.5-.5L3.86 31a.19.19 0 0 0-.18-.14a.2.2 0 0 0-.19.14l-.58 1.73a.8.8 0 0 1-.5.5l-1.73.58a.19.19 0 0 0-.14.18a.2.2 0 0 0 .14.19l1.73.58a.78.78 0 0 1 .5.5l.58 1.73a.2.2 0 0 0 .19.14a.19.19 0 0 0 .18-.14Z"
      />
    </svg>

    <h1>Witchy Bell</h1>
    <p>Set the duration and click play to start the timer.</p>
    <template v-if="!playing">
      {{ duration }} {{ +duration === 1 ? "minute" : "minutes" }}
    </template>
    <template v-else>
      {{ whenIsNextDing }}
    </template>
    <input
      v-if="!playing"
      v-model="duration"
      :disabled="playing"
      type="range"
      min="0.5"
      max="10"
      step="0.5"
    />
    <!-- a loading bar, showing progress until next ding -->
    <progress
      v-else
      :max="duration * 60"
      :value="duration * 60 - Math.floor((nextDing - now) / 1000)"
    >
      70%
    </progress>

    <button style="margin-top: 0.75rem" @click="playing = !playing">
      {{ playing ? "Stop" : "Play" }}
    </button>
  </section>
</template>

<script setup lang="ts">
import ding from "./assets/ding.wav";
// @ts-ignore
import { useSound } from "@vueuse/sound";
import { ref, watch, computed, reactive, watchEffect } from "vue";

const duration = ref<number>(+(localStorage.getItem("duration") || "1"));
const playing = ref<boolean>(false);
const { play } = useSound(ding);
const timeout = ref<any>(undefined);
const trackNow = ref<any>(undefined);
const nextDing = ref<number>(0);
const now = ref(Date.now());

const wakeLock = reactive<{
  lock: null | WakeLockSentinel;
  request: () => void;
  release: () => void;
}>({
  lock: null,
  request() {
    if ("wakeLock" in navigator) {
      navigator.wakeLock
        .request("screen")
        .then((lock) => {
          this.lock = lock;
        })
        .catch(console.error);
    }
  },
  release() {
    if (this.lock) {
      this.lock.release();
      this.lock = null;
    }
  },
});

const whenIsNextDing = computed(() => {
  // Determine the time difference between now and `nextDing` in seconds
  const diff = Math.floor((nextDing.value - now.value) / 1000);
  // If the difference is less than 60 seconds, return the difference
  if (diff < 60) return `${diff} ${diff === 1 ? "second" : "seconds"}`;
  // Otherwise, return the difference in minutes
  return `${Math.floor(diff / 60)} ${diff / 60 < 2 ? "minute" : "minutes"}`;
});

function playDing() {
  play();
  if (playing) {
    nextDing.value = Date.now() + duration.value * 1000 * 60;
    timeout.value = setTimeout(playDing, duration.value * 1000 * 60);
  }
}

watch(playing, (newPlaying) => {
  if (newPlaying) {
    playDing();
    wakeLock.request();
    now.value = Date.now();
    trackNow.value = setInterval(() => {
      now.value = Date.now();
    }, 1000);
    setTimeout(() => {
      now.value = Date.now();
    }, 1);
  } else {
    clearTimeout(timeout.value);
    wakeLock.release();
    clearInterval(trackNow.value);
  }
});

watchEffect(() => {
  localStorage.setItem("duration", duration.value.toString());
});
</script>

<style scoped>
section {
  display: flex;
  flex-direction: column;
}

progress {
  width: 100%;
}

h1 {
  margin: 1rem;
}

progress,
input[type="range"] {
  height: 1rem;
  margin: 0;
}
</style>
